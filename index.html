<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<!-- The MIT License (MIT)

Copyright (c) 2015 James Cipar

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE. -->

<head>
<title>Brewing Salts</title>


<script type="text/javascript" src="numeric-1.2.6.js"></script>
<script type="text/javascript" src="brewing-salts-numeric.js"></script>
<script type="text/javascript" src="water-profile-library.js"></script>
<link rel="stylesheet" type="text/css" href="brewing-salts.css" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

<script type="text/javascript">
"use strict";


var salt_names = {
	"gypsum": {
		"name": "Gypsum",
		"href": "http://www.amazon.com/gp/product/B0064OGEZG/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B0064OGEZG&linkCode=as2&tag=affectenterplantsteep-20&linkId=STJPJ7IW6NNNMK5P"
	},
	"epsom": {
		"name": "Epsom",
		"href": "http://www.amazon.com/gp/product/B00JPITKP4/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B00JPITKP4&linkCode=as2&tag=affectenterplantsteep-20&linkId=NGAHF62RAWKQZE4W"
	},
	"table": {
		"name": "Table Salt"
	},
	"baking_soda": {
		"name": "Baking Soda"
	},
	"calcium_chloride": {
		"name": "Calcium Chloride",
		"href": 'http://www.amazon.com/gp/product/B0064OGEVU/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B0064OGEVU&linkCode=as2&tag=affectenterplantsteep-20&linkId=DJUDISPURWWFFXQ4'
	},
	"chalk": {
		"name": "Chalk (Calcium Carbonate)",
		"href": "http://www.amazon.com/gp/product/B0064GZPPO/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B0064GZPPO&linkCode=as2&tag=affectenterplantsteep-20&linkId=AF4SKAYMAWPALXCG"
	},
	"pickling_lime": {
		"name": "Pickling Lime (Calcium Hydroxide)",
		"href": "http://www.amazon.com/gp/product/B0084LZU1Q/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B0084LZU1Q&linkCode=as2&tag=affectenterplantsteep-20&linkId=5LY6HTXQQFQA2L2C"
	},
	"magnesium_chloride": {
		"name": "Magnesium Chloride",
	//	"href": "http://www.amazon.com/gp/product/B00I86NLYA/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B00I86NLYA&linkCode=as2&tag=affectenterplantsteep-20&linkId=ZMDTI4VOA3RD75J6"
	}
}

var ion_names = {
	"calcium": {
		"name": "Calcium"
	},
	"magnesium": {
		"name": "Magnesium"
	},
	"sodium": {
		"name": "Sodium"
	},
	"sulfate": {
		"name": "Sulfate"
	},
	"chloride": {
		"name": "Chloride",
	},
	"bicarbonate": {
		"name": "Bicarbonate"
	}
}


function round(value, exp) {
  if (typeof exp === 'undefined' || +exp === 0)
    return Math.round(value);

  value = +value;
  exp  = +exp;

  if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0))
    return NaN;

  // Shift
  value = value.toString().split('e');
  value = Math.round(+(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp)));

  // Shift back
  value = value.toString().split('e');
  return +(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp));
}

function optimize()
{
	var input = example_input;
	for (var ion in input.target_profile) {
		var input_name = "#input-" + ion;
		input.target_profile[ion] = Number($(input_name).val());
	}
	for (var ion in input.initial_profile) {
		var input_name = "#starting-" + ion;
		input.initial_profile[ion] = Number($(input_name).val());
	}
	input.water_gallons = Number($('#water-gallons').val());
	input.boil_volume = Number($('#boil-gallons').val());
	for (var salt in parameters.salts) {
		if ($('#use-'+salt).is(':checked')) {
			input.max_salts[salt] = 1000.0;
		} else {
			delete input.max_salts[salt];
		}
	}

	var maintain_ratios = $('#maintain-sulfate-chloride-ratio').is(':checked')	;
	// preserve sulfate:chloride ratio, rather than hitting targets
	if (maintain_ratios && (input.initial_profile.chloride > input.target_profile.chloride)) {
		var b = input.initial_profile.chloride / input.target_profile.chloride;
		input.target_profile.chloride = input.initial_profile.chloride;
		input.target_profile.sulfate *= b;
		// alert("Increasing sulfate target to maintain chloride:sulfate ratio, due to high chloride.");
	}
	if (maintain_ratios && (input.initial_profile.sulfate > input.target_profile.sulfate)) {
		var b = input.initial_profile.sulfate / input.target_profile.sulfate;
		input.target_profile.sulfate = input.initial_profile.sulfate;
		input.target_profile.chloride *= b;
		// alert("Increasing chloride target to maintain chloride:sulfate ratio, due to high sulfate.");

	}
	console.log(JSON.stringify(input));
	var result = optimize_salts(parameters, input);
	clear_output_tables();
	reset_ion_table(input);
	// alert(JSON.stringify(result));
	for (var salt in result.salts_g_gal) {
		var output_name = '#g-gal-' + salt;
		$(output_name).html(round(result.salts_g_gal[salt],2));
	}
	for (var salt in result.salts_g) {
		var output_name = '#g-' + salt;
		$(output_name).html(round(result.salts_g[salt],2));
	}
	for (var salt in result.salts_tsp) {
		var output_name = '#tsp-' + salt;
		$(output_name).html(round(result.salts_tsp[salt],2));
	}

	for (var ion in input.target_profile) {
		var output_name = "#target-" + ion;
		$(output_name).html(round(input.target_profile[ion],2));
	}

	for (var ion in input.target_profile) {
		var output_name = "#added-" + ion;
		$(output_name).html(round(result.ions_added[ion],2));
	}

	for (var ion in input.target_profile) {
		var output_name = "#total-" + ion;
		$(output_name).html(round(result.ions[ion],2));
	}

	for (var ion in input.target_profile) {
		var output_name = "#error-" + ion;
		$(output_name).html(round(result.ion_errors[ion],2));
	}
	$("#g-gallons").html("grams in " + input.water_gallons + " gallons")
	$("#tsp-gallons").html("tsp in " + input.water_gallons + " gallons")
}


function clear_output_tables()
{
	for (var salt in parameters.salts) {
		$('#g-gal-'+salt).html('');
		$('#g-'+salt).html('');
		$('#tsp-'+salt).html('');
	}
// TODO: clear ion table
}


function set_starting()
{
	var profile_name = $("#starting-profile-select").val();
	var profile = standard_initial_profiles[profile_name];
	for (var ion in profile) {
		var input_name = "#starting-" + ion;
		$(input_name).val(profile[ion]);
	}
}


function set_desired()
{
	var profile_name = $("#desired-profile-select").val();
	var profile = standard_target_profiles[profile_name];
	for (var ion in profile) {
		var input_name = "#input-" + ion;
		$(input_name).val(profile[ion]);
	}
}


function setup_salt_table()
{
	var i=0;
	for (var salt in parameters.salts) {
		var name = salt;
		var href = null;
		if (salt in salt_names) {
			name = salt_names[salt].name;
			href = salt_names[salt].href;
			if (href) {
				name = name+" <a href='"+href+"'>[buy]</a>"
			}
		}
		$('#salt-table').append("<tr " + (i%2==1 ? "class='grayrow'":"") + " >"
			+ "<td>"+name+"</td>"
			+ "<td><input type='checkbox' id='use-"+salt+"' checked onChange='optimize();' /></td>"
			+ "<td id='g-gal-"+salt+"'></td>"
			+ "<td id='g-"+salt+"'></td>"
			+ "<td id='tsp-"+salt+"'></td>"
			+ "</tr>");
		i++;
	}
};


function reset_ion_table(input)
{
	$('#ion-table').empty();
	$('#ion-table').append("<tr>"
	+ "<th></th>"
	+ "<th>Added</th>"
	+ "<th>Total</th>"
	+ "<th>Target</th>"
	+ "<th>Error</th>"
	+ "</tr>");
	if (!input) { return; }
	var i=0;
	for (var ion in input.target_profile) {
		var ion_name = ion_names[ion] ? ion_names[ion].name : ion;
		$('#ion-table').append(
			"<tr " + (i%2==1 ? "class='grayrow'":"") + " >"
			+ "<td>"+ion_name+"</td>"
			+ "<td id='added-"+ion+"'></td>"
			+ "<td id='total-"+ion+"'></td>"
			+ "<td id='target-"+ion+"'></td>"
			+ "<td id='error-"+ion+"'></td>"
			+ "</tr>"
			);
		i++
	}
}


$(document).ready(function() {
	for (var profile_name in standard_initial_profiles) {
		$('#starting-profile-select')
          .append($('<option>', { value : profile_name })
          .text(profile_name));
	}
	for (var profile_name in standard_target_profiles) {
		$('#desired-profile-select')
          .append($('<option>', { value : profile_name })
          .text(profile_name));
	}

	setup_salt_table();
	reset_ion_table(example_input);
	optimize();
});
</script>

</head>
<body>

<div id="content">
<h1>Brewing Salts Calculator</h1>



<label>Gallons of water to treat (mash): </label><input type="number" id='water-gallons' value=5.0 step='any' min=0 onChange='optimize();' />
<br>
<label>Gallons of water to treat (boil): </label><input type="number" id='boil-gallons' value=5.0 step='any' min=0 onChange='optimize();' />
<br>


<table>

<tr>
<th></th>
<th>Standard profiles</th>
<th>Calcium</th>
<th>Magnesium</th>
<th>Sodium</th>
<th>Sulfate</th>
<th>Chloride</th>
<th>Bicarbonate</th>
</tr>

<tr>
<td>Desired Profile</td>
<td>
<select id="desired-profile-select" onChange="set_desired(); optimize();">
<option></option>
</select>
</td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-calcium' value=0.0 /></td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-magnesium' value=0.0 /></td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-sodium' value=0.0 /></td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-sulfate' value=0.0 /></td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-chloride' value=0.0 /></td>
<td><input type="number" class='ion-input' onChange='optimize();' step='any' min=0 id='input-bicarbonate' value=0.0 /></td>
</tr>

<tr>
<td>Starting Profile</td>
<td>
<select id="starting-profile-select" onChange="set_starting(); optimize();">
<option></option>
</select>
</td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-calcium' value=0.0 /></td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-magnesium' value=0.0 /></td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-sodium' value=0.0 /></td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-sulfate' value=0.0 /></td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-chloride' value=0.0 /></td>
<td><input type="number" class = 'ion-input' onChange='optimize();' step='any' min=0 id='starting-bicarbonate' value=0.0 /></td>
</tr>

</table>

<label>Maintain Sulfate:Chloride ratio even if it goes over targets: </label>
<input type="checkbox" id='maintain-sulfate-chloride-ratio' onChange='optimize();' /><br>

<table id='salt-table'>

<tr>
<th></th>
<th>Enabled</th>
<th>grams/gallon</th>
<th id='g-gallons'>grams in X gallons</th>
<th id='tsp-gallons'>tsp in X gallons</th>
</tr>
</table>


<table id='ion-table'>
<tr>
	<th></th>
	<th>Added</th>
	<th>Total</th>
	<th>Target</th>
	<th>Error</th>
</tr>
</table>

</div> <!-- Content -->

<center><a href='LICENSE' class='smalllink'>Copyright, James Cipar. [MIT License]</a></center>
</body>

</html>
